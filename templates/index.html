{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <button id="prevDay" class="btn btn-outline-secondary">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <input type="date" id="datePicker" class="form-control" value="{{ date }}">
                <button id="nextDay" class="btn btn-outline-secondary">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button id="todayBtn" class="btn btn-outline-primary ms-2">Today</button>
                <!-- Add current time display -->
                <span id="currentTime" class="ms-2 badge bg-dark">12:50</span>
                <!-- Add save button and last saved timestamp -->
                <button id="saveButton" class="btn btn-sm btn-primary ms-3">Save</button>
                <small id="lastSaved" class="text-muted ms-3" style="opacity: 0.7;">Last saved: 12:50:57 PM</small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="rating">
                    {% for i in range(5, 0, -1) %}
                    <input type="radio" name="rating" id="rating{{ i }}" value="{{ i }}"
                           {% if i == productivity_rating %}checked{% endif %}>
                    <label for="rating{{ i }}"><i class="fas fa-star"></i></label>
                    {% endfor %}
                </div>
                <button id="closeDay" class="btn btn-outline-success">
                    <i class="fas fa-check-circle me-1"></i>Close Day
                </button>
            </div>
        </div>
    </div>
</div>

<div class="time-block-controls text-center mb-3">
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary btn-sm add-earlier-blocks">
            <i class="fas fa-plus"></i> Add Earlier Blocks
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm remove-earlier-blocks">
            <i class="fas fa-minus"></i> Remove Block
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Time Statistics</h5>
            </div>
            <div class="card-body">
                {% if total_minutes > 0 %}
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <h6 class="mb-0">Total Daily Hours</h6>
                    <span class="h6 mb-0">{{ (total_minutes / 60)|round(1) }} hrs</span>
                </div>
                {% endif %}

                {% for category_id, stats in category_stats.items() %}
                <div class="mb-3">
                    <h6 class="mb-2" style="color: {{ stats.color }}">
                        <i class="fas fa-square me-1" style="color: {{ stats.color }}"></i>
                        {{ stats.name }}
                    </h6>
                    <div class="ps-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small>Total Time</small>
                            <small>{{ (stats.minutes / 60)|round(1) }} hrs</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Today's Priorities</h5>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#taskSelectorModal">
                    <i class="fas fa-plus"></i> Add from Tasks
                </button>
            </div>
            <div class="card-body">
                <ul id="prioritiesList" class="list-group">
                    {% for i in range(5) %}
                    <li class="list-group-item">
                        <div class="input-group">
                            <div class="input-group-text">
                                <input type="checkbox" class="priority-checkbox"
                                       {% if i < priorities|length and priorities[i].completed %}checked{% endif %}>
                            </div>
                            <input type="text" class="form-control priority-input {% if i < priorities|length and priorities[i].completed %}completed{% endif %}"
                                   placeholder="Priority {{ i + 1 }} or select from your tasks"
                                   value="{{ priorities[i].content if i < priorities|length else '' }}">
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                
                {% if available_tasks %}
                <div class="mt-3">
                    <h6 class="text-muted mb-2">Suggested Tasks for Today:</h6>
                    <div class="d-flex flex-wrap gap-1">
                        {% for task in available_tasks[:8] %}
                        <button class="btn btn-sm btn-outline-secondary task-suggestion" 
                                data-task-title="{{ task.title }}"
                                data-task-priority="{{ task.priority }}"
                                data-task-role="{{ task.assigned_role.name if task.assigned_role else '' }}"
                                title="{{ task.description or 'No description' }}">
                            <span class="badge bg-{{ task.get_priority_color() }} me-1">{{ task.priority }}</span>
                            {{ task.title[:30] }}{% if task.title|length > 30 %}...{% endif %}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Notes</h5>
            </div>
            <div class="card-body">
                <textarea id="brainDump" class="form-control" rows="5"
                          placeholder="Write your thoughts here...">{{ brain_dump }}</textarea>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Time Blocks</h5>
            </div>
            <div class="card-body">
                <div id="timeBlocks" class="time-blocks">
                    <!-- Morning Hours (5:00 AM - 11:45 AM) -->
                    <div class="time-block-column">
                        <h6 class="text-muted mb-2">Early Morning</h6>
                        {% for hour in range(5, 12) %}
                            {% for minute in [0, 15, 30, 45] %}
                                {% if not (hour == 5 and minute < 30) %}
                                {% set current_time = '%02d:%02d'|format(hour, minute) %}
                                {% set saved_block = time_blocks|selectattr('start_time', 'equalto', current_time)|first %}
                                <div class="time-block" data-time="{{ current_time }}">
                                    <div class="drag-handle">
                                        <i class="fas fa-grip-vertical"></i>
                                    </div>
                                    <div class="time-label">{{ current_time }}</div>
                                    <div class="time-content {% if saved_block and saved_block.task_id %}has-task{% endif %}">
                                        <select class="form-select form-select-sm task-select">
                                            <option value="">Select a task</option>
                                            <option value="new">+ Add New Task</option>
                                            {% for category in categories %}
                                                <optgroup label="{{ category.name }}" data-color="{{ category.color }}" data-category-id="{{ category.id }}">
                                                    {% for task in category.tasks %}
                                                        <option value="{{ task.id }}"
                                                                data-category-color="{{ category.color }}"
                                                                {% if saved_block and saved_block.task_id == task.id %}selected{% endif %}>
                                                            {{ task.title }}
                                                        </option>
                                                    {% endfor %}
                                                </optgroup>
                                            {% endfor %}
                                        </select>
                                        <input type="text" class="form-control form-control-sm task-notes"
                                               placeholder="Add notes..."
                                               maxlength="15"
                                               value="{{ saved_block.notes if saved_block and saved_block.notes else '' }}"
                                               style="display: {% if saved_block and saved_block.task_id %}inline-block{% else %}none{% endif %};
                                                      width: 100px;
                                                      margin-left: 4px;">
                                        <div class="task-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary task-control-btn copy-up" title="Copy Up">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary task-control-btn copy-down" title="Copy Down">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>

                    <!-- Afternoon Hours (12 PM - 5:45 PM) -->
                    <div class="time-block-column">
                        <h6 class="text-muted mb-2">Afternoon</h6>
                        {% for hour in range(12, 18) %}
                            {% for minute in [0, 15, 30, 45] %}
                                {% set current_time = '%02d:%02d'|format(hour, minute) %}
                                {% set saved_block = time_blocks|selectattr('start_time', 'equalto', current_time)|first %}
                                <div class="time-block" data-time="{{ current_time }}">
                                    <div class="drag-handle">
                                        <i class="fas fa-grip-vertical"></i>
                                    </div>
                                    <div class="time-label">{{ current_time }}</div>
                                    <div class="time-content {% if saved_block and saved_block.task_id %}has-task{% endif %}">
                                        <select class="form-select form-select-sm task-select">
                                            <option value="">Select a task</option>
                                            <option value="new">+ Add New Task</option>
                                            {% for category in categories %}
                                                <optgroup label="{{ category.name }}" data-color="{{ category.color }}" data-category-id="{{ category.id }}">
                                                    {% for task in category.tasks %}
                                                        <option value="{{ task.id }}"
                                                                data-category-color="{{ category.color }}"
                                                                {% if saved_block and saved_block.task_id == task.id %}selected{% endif %}>
                                                            {{ task.title }}
                                                        </option>
                                                    {% endfor %}
                                                </optgroup>
                                            {% endfor %}
                                        </select>
                                        <input type="text" class="form-control form-control-sm task-notes"
                                               placeholder="Add notes..."
                                               maxlength="15"
                                               value="{{ saved_block.notes if saved_block and saved_block.notes else '' }}"
                                               style="display: {% if saved_block and saved_block.task_id %}inline-block{% else %}none{% endif %};
                                                      width: 100px;
                                                      margin-left: 4px;">
                                        <div class="task-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary task-control-btn copy-up" title="Copy Up">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary task-control-btn copy-down" title="Copy Down">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="time-block-controls text-center mt-3">
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary btn-sm add-later-blocks">
            <i class="fas fa-plus"></i> Add Later Blocks
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm remove-later-blocks">
            <i class="fas fa-minus"></i> Remove Block
        </button>
    </div>
</div>

<!-- Open Tasks Section -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Open Tasks</h5>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/tasks'">
                    <i class="fas fa-plus"></i> Add New Task
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for role in [{'id': 1, 'name': 'APS', 'color': '#007bff'}, {'id': 2, 'name': 'Home', 'color': '#28a745'}, {'id': 3, 'name': 'Church', 'color': '#6f42c1'}] %}
                    <div class="col-md-4">
                        <div class="border rounded p-3 h-100" style="border-color: {{ role.color }}!important;">
                            <h6 class="mb-3" style="color: {{ role.color }}">
                                <i class="fas fa-circle me-1" style="color: {{ role.color }}"></i>
                                {{ role.name }}
                            </h6>
                            <div class="task-list">
                                {% for task in all_open_tasks %}
                                    {% if task.role_id == role.id %}
                                    <div class="task-item mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold">{{ task.title }}</div>
                                                {% if task.due_date %}
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    Due: {{ task.due_date.strftime('%m/%d') }}
                                                    {% if task.due_date.date() < today %}
                                                    <span class="badge bg-danger ms-1">Overdue</span>
                                                    {% elif task.due_date.date() == today %}
                                                    <span class="badge bg-warning ms-1">Due Today</span>
                                                    {% endif %}
                                                </small>
                                                {% endif %}
                                                {% if task.is_recurring %}
                                                <small class="badge bg-secondary ms-1">
                                                    <i class="fas fa-repeat"></i>
                                                </small>
                                                {% endif %}
                                            </div>
                                            <div class="task-actions">
                                                <span class="badge bg-{{ task.get_priority_color() }}">{{ task.priority }}</span>
                                            </div>
                                        </div>
                                        {% if task.description %}
                                        <div class="mt-1">
                                            <small class="text-muted">{{ task.description[:60] }}{% if task.description|length > 60 %}...{% endif %}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">External Tools</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for link in current_user.nav_links %}
                        {% if link.embed %}
                        <div class="{% if link.full_width %}col-12{% else %}col-md-6{% endif %} mb-4">
                            {% if link.custom_iframe_code %}
                                {{ link.custom_iframe_code|safe }}
                            {% else %}
                            <div class="embed-responsive" style="position: relative; overflow: hidden; padding-top: {{ link.iframe_height }}px;">
                                <iframe src="{{ link.url }}"
                                        style="position: absolute; top: 0; left: 0; width: {{ link.iframe_width_percent }}%; height: 100%; border: 1px solid #ddd; border-radius: 8px;"
                                        frameborder="0"
                                        allowfullscreen>
                                </iframe>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickTaskForm">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="taskCategory" class="form-label">Category</label>
                        <select class="form-select" id="taskCategory" required>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQuickTask">Save Task</button>
            </div>
        </div>
    </div>
</div>

<style>
.time-indicator {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #ff3333;
    z-index: 100;
    pointer-events: none;
    border-top: 1px solid rgba(255, 51, 51, 0.8);
    box-shadow: 0 1px 3px rgba(255, 51, 51, 0.4);
}

.time-block {
    position: relative;
    height: 40px;  /* Set explicit height */
}

.time-block-column {
    position: relative;
}

#timeBlocks {
    position: relative;
}

.time-block-controls {
    padding: 10px;
    background: rgba(0,0,0,0.02);
    border-radius: 4px;
}

.time-block-controls button {
    min-width: 120px;
}

.time-block-controls .btn-group {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-block-controls .btn-outline-danger {
    border-left: none;
}
</style>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/timeblock.js') }}"></script>
<script>
// Update current time display
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    document.getElementById('currentTime').textContent = timeString;
}

// Update time indicator position
function updateTimeIndicator() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    // Remove existing indicator
    const existingIndicator = document.querySelector('.time-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }

    // Only show indicator for current day
    const currentDate = new Date().toISOString().split('T')[0];
    const selectedDate = document.getElementById('datePicker').value;
    if (currentDate !== selectedDate) {
        return;
    }

    // Find the relevant time block
    const timeString = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
    const timeBlocks = document.querySelectorAll('.time-block');

    for (let i = 0; i < timeBlocks.length; i++) {
        const block = timeBlocks[i];
        const blockTime = block.dataset.time;

        if (blockTime <= timeString) {
            const nextBlock = timeBlocks[i + 1];
            if (!nextBlock || nextBlock.dataset.time > timeString) {
                // Calculate indicator position
                const blockTop = block.offsetTop;
                const blockHeight = block.offsetHeight;
                const minutes = currentMinute % 15;
                const percentage = (minutes / 15);

                // Create and position the indicator
                const indicator = document.createElement('div');
                indicator.className = 'time-indicator';

                // Position relative to the block
                const column = block.closest('.time-block-column');
                const position = blockTop + (blockHeight * percentage);
                indicator.style.top = `${position}px`;
                indicator.style.width = '100%';

                // Add the indicator to the column
                column.appendChild(indicator);
                break;
            }
        }
    }
}

// Update time every 5 minutes
setInterval(updateCurrentTime, 300000);
updateCurrentTime(); // Initial update

// Update indicator every 5 minutes
setInterval(updateTimeIndicator, 300000);
updateTimeIndicator(); // Initial update

// Also update indicator when changing dates
document.getElementById('datePicker').addEventListener('change', updateTimeIndicator);
document.getElementById('prevDay').addEventListener('click', updateTimeIndicator);
document.getElementById('nextDay').addEventListener('click', updateTimeIndicator);
document.getElementById('todayBtn').addEventListener('click', updateTimeIndicator);


document.querySelector('.add-earlier-blocks').addEventListener('click', function() {
    const firstBlock = document.querySelector('.time-block');
    if (firstBlock) {
        const currentTime = firstBlock.dataset.time;
        const [hours, minutes] = currentTime.split(':').map(Number);

        // Calculate new time (15 minutes earlier)
        let newMinutes = minutes - 15;
        let newHours = hours;

        if (newMinutes < 0) {
            newMinutes = 45;
            newHours--;
        }

        if (newHours >= 0) {  // Don't go before midnight
            const newTimeString = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;

            // Clone the first block and update its time
            const newBlock = firstBlock.cloneNode(true);
            newBlock.dataset.time = newTimeString;
            newBlock.querySelector('.time-label').textContent = newTimeString;

            // Clear any selected task
            const select = newBlock.querySelector('.task-select');
            select.value = '';

            // Insert the new block at the beginning
            firstBlock.parentNode.insertBefore(newBlock, firstBlock);

            // Reinitialize event listeners for the new block
            initializeTimeBlock(newBlock);
        }
    }
});

document.querySelector('.add-later-blocks').addEventListener('click', function() {
    const lastBlock = document.querySelector('.time-block:last-child');
    if (lastBlock) {
        const currentTime = lastBlock.dataset.time;
        const [hours, minutes] = currentTime.split(':').map(Number);

        // Calculate new time (15 minutes later)
        let newMinutes = minutes + 15;
        let newHours = hours;

        if (newMinutes >= 60) {
            newMinutes = 0;
            newHours++;
        }

        if (newHours < 24) {  // Don't go past midnight
            const newTimeString = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;

            // Clone the last block and update its time
            const newBlock = lastBlock.cloneNode(true);
            newBlock.dataset.time = newTimeString;
            newBlock.querySelector('.time-label').textContent = newTimeString;

            // Clear any selected task
            const select = newBlock.querySelector('.task-select');
            select.value = '';

            // Add the new block at the end
            lastBlock.parentNode.appendChild(newBlock);

            // Reinitialize event listeners for the new block
            initializeTimeBlock(newBlock);
        }
    }
});

// Function to initialize event listeners for a time block
function initializeTimeBlock(block) {
    // Re-initialize select change handler
    const select = block.querySelector('.task-select');
    select.addEventListener('change', function() {
        const notesInput = this.parentElement.querySelector('.task-notes');
        notesInput.style.display = this.value ? 'inline-block' : 'none';
        notesInput.value = '';

        if (this.value === 'new') {
            // Handle new task creation
            const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            modal.show();
        }
    });

    // Re-initialize copy buttons
    block.querySelector('.copy-up').addEventListener('click', function() {
        const prevBlock = block.previousElementSibling;
        if (prevBlock) {
            const prevSelect = prevBlock.querySelector('.task-select');
            const currentSelect = block.querySelector('.task-select');
            prevSelect.value = currentSelect.value;
            prevSelect.dispatchEvent(new Event('change'));
        }
    });

    block.querySelector('.copy-down').addEventListener('click', function() {
        const nextBlock = block.nextElementSibling;
        if (nextBlock) {
            const nextSelect = nextBlock.querySelector('.task-select');
            const currentSelect = block.querySelector('.task-select');
            nextSelect.value = currentSelect.value;
            nextSelect.dispatchEvent(new Event('change'));
        }
    });
}

document.querySelector('.remove-earlier-blocks').addEventListener('click', function() {
    const firstBlock = document.querySelector('.time-block');
    if (firstBlock) {
        const select = firstBlock.querySelector('.task-select');
        if (select.value) {
            alert('Cannot remove block with assigned task. Please clear the task first.');
            return;
        }
        firstBlock.remove();
    }
});

document.querySelector('.remove-later-blocks').addEventListener('click', function() {
    const lastBlock = document.querySelector('.time-block:last-child');
    if (lastBlock) {
        const select = lastBlock.querySelector('.task-select');
        if (select.value) {
            alert('Cannot remove block with assigned task. Please clear the task first.');
            return;
        }
        lastBlock.remove();
    }
});
</script>
{% endblock %}