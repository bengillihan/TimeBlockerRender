{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <button id="prevDay" class="btn btn-outline-secondary">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <input type="date" id="datePicker" class="form-control" value="{{ date }}">
                <button id="nextDay" class="btn btn-outline-secondary">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button id="todayBtn" class="btn btn-outline-primary ms-2">Today</button>
                <!-- Add current time display -->
                <span id="currentTime" class="ms-2 badge bg-dark">12:50</span>
                <!-- Add save button and last saved timestamp -->
                <button id="saveButton" class="btn btn-sm btn-primary ms-3">Save</button>
                <small id="lastSaved" class="text-muted ms-3" style="opacity: 0.7;">Last saved: 12:50:57 PM</small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <!-- PTO Hours Input -->
                <div class="d-flex align-items-center">
                    <label for="ptoHours" class="form-label mb-0 me-2">
                        <i class="fas fa-calendar-check me-1 text-success"></i>
                        PTO Hours:
                    </label>
                    <div class="input-group" style="width: 120px;">
                        <input type="number" id="ptoHours" class="form-control form-control-sm" 
                               min="0" max="24" step="0.5" 
                               value="{{ daily_plan.pto_hours if daily_plan and daily_plan.pto_hours else 0 }}"
                               placeholder="0"
                               onchange="updatePTOHours()">
                        <span class="input-group-text">hrs</span>
                    </div>
                </div>
                
                <div class="rating">
                    {% for i in range(5, 0, -1) %}
                    <input type="radio" name="rating" id="rating{{ i }}" value="{{ i }}"
                           {% if i == productivity_rating %}checked{% endif %}>
                    <label for="rating{{ i }}"><i class="fas fa-star"></i></label>
                    {% endfor %}
                </div>
                <button id="closeDay" class="btn btn-outline-success">
                    <i class="fas fa-check-circle me-1"></i>Close Day
                </button>
            </div>
        </div>
    </div>
</div>

<div class="time-block-controls text-center mb-3">
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary btn-sm add-earlier-blocks">
            <i class="fas fa-plus"></i> Add Earlier Blocks
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm remove-earlier-blocks">
            <i class="fas fa-minus"></i> Remove Block
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Time Statistics</h5>
                <div class="btn-group">
                    <button id="refreshTotalsBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> Refresh Totals
                    </button>
                    <button id="recoverDataBtn" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-history"></i> Recover Data
                    </button>
                    <button id="restoreTodayBtn" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-undo"></i> Restore Today's Plan
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if total_minutes > 0 %}
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <h6 class="mb-0">Total Daily Hours</h6>
                    <span class="h6 mb-0">{{ (total_minutes / 60)|round(1) }} hrs</span>
                </div>
                
                <!-- PTO Hours Display -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted">
                        <i class="fas fa-calendar-check me-1 text-success"></i>
                        PTO Hours Today
                    </small>
                    <small id="ptoHoursDisplay" class="fw-bold text-success">{{ daily_plan.pto_hours if daily_plan and daily_plan.pto_hours else 0 }} hrs</small>
                </div>
                {% endif %}
                
                <!-- Work Week Tracking (Mon-Sun) -->
                <div id="workWeekTracking" class="mb-3 pb-2 border-bottom">
                    <h6 class="mb-2 text-success">
                        <i class="fas fa-briefcase me-1"></i>Work Week <small class="text-muted" id="workWeekDates">(Mon-Sun)</small>
                    </h6>
                    <div class="ps-3" id="workWeekStats">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="workWeekWorkColor"></i>Work</small>
                            <small id="workWeekWork" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="workWeekConsultingColor"></i>Consulting</small>
                            <small id="workWeekConsulting" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="workWeekChurchColor"></i>Church</small>
                            <small id="workWeekChurch" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="workWeekPersonalColor"></i>Personal</small>
                            <small id="workWeekPersonal" class="fw-bold">Loading...</small>
                        </div>
                    </div>
                </div>
                
                <!-- 7-Day Tracking Section -->
                <div id="sevenDayTracking" class="mb-3 pb-2 border-bottom">
                    <h6 class="mb-2 text-info">
                        <i class="fas fa-calendar-week me-1"></i>7-Day Tracking
                        <button class="btn btn-sm btn-link p-0 text-muted float-end" onclick="showWorkHourSettings()" style="font-size: 0.75rem;">
                            <i class="fas fa-cog"></i>
                        </button>
                    </h6>
                    <div class="ps-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small>Last 7 Days Total</small>
                            <small id="sevenDayTotal" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="sevenDayWorkColor"></i>Work</small>
                            <small id="sevenDayWork" class="fw-bold">Loading...</small>
                        </div>
                        <div class="progress mt-1 mb-2" style="height: 6px;">
                            <div id="workProgressBar" class="progress-bar" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="32">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="sevenDayConsultingColor"></i>Consulting</small>
                            <small id="sevenDayConsulting" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="sevenDayChurchColor"></i>Church</small>
                            <small id="sevenDayChurch" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="sevenDayPersonalColor"></i>Personal</small>
                            <small id="sevenDayPersonal" class="fw-bold">Loading...</small>
                        </div>
                        <div class="text-muted mt-2">
                            <small>Work Goal: <span id="weeklyGoalDisplay">32</span> hrs/week</small>
                        </div>
                    </div>
                </div>
                
                <!-- 30-Day Tracking Section -->
                <div id="thirtyDayTracking" class="mb-3 pb-2 border-bottom">
                    <h6 class="mb-2 text-warning">
                        <i class="fas fa-calendar-alt me-1"></i>30-Day Tracking
                    </h6>
                    <div class="ps-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="thirtyDayWorkColor"></i>Work</small>
                            <small id="thirtyDayWork" class="fw-bold">Loading...</small>
                        </div>
                        <div class="progress mt-1 mb-2" style="height: 6px;">
                            <div id="monthlyWorkProgressBar" class="progress-bar" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="140">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="thirtyDayConsultingColor"></i>Consulting</small>
                            <small id="thirtyDayConsulting" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="thirtyDayChurchColor"></i>Church</small>
                            <small id="thirtyDayChurch" class="fw-bold">Loading...</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><i class="fas fa-square me-1" id="thirtyDayPersonalColor"></i>Personal</small>
                            <small id="thirtyDayPersonal" class="fw-bold">Loading...</small>
                        </div>
                        <div class="text-muted mt-2">
                            <small>Work Goal: <span id="monthlyGoalDisplay">140</span> hrs/month</small>
                        </div>
                    </div>
                </div>

                {% for category_id, stats in category_stats.items() %}
                <div class="mb-3">
                    <h6 class="mb-2" style="color: {{ stats.color }}">
                        <i class="fas fa-square me-1" style="color: {{ stats.color }}"></i>
                        {{ stats.name }}
                    </h6>
                    <div class="ps-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small>Total Time</small>
                            <small>{{ (stats.minutes / 60)|round(1) }} hrs</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Today's Priorities</h5>
            </div>
            <div class="card-body">
                <ul id="prioritiesList" class="list-group">
                    {% for i in range(5) %}
                    <li class="list-group-item">
                        <div class="input-group">
                            <div class="input-group-text">
                                <input type="checkbox" class="priority-checkbox"
                                       {% if i < priorities|length and priorities[i].completed %}checked{% endif %}>
                            </div>
                            <input type="text" class="form-control priority-input {% if i < priorities|length and priorities[i].completed %}completed{% endif %}"
                                   placeholder="Priority {{ i + 1 }}"
                                   value="{{ priorities[i].content if i < priorities|length else '' }}">
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Notes</h5>
            </div>
            <div class="card-body">
                <textarea id="brainDump" class="form-control" rows="5"
                          placeholder="Write your thoughts here...">{{ brain_dump }}</textarea>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Time Blocks</h5>
            </div>
            <div class="card-body">
                <div id="timeBlocks" class="time-blocks">
                    <!-- Morning Hours -->
                    <div class="time-block-column">
                        <h6 class="text-muted mb-2">Morning</h6>
                        {% for hour in range(current_user.day_start_time.hour, current_user.day_split_time.hour) %}
                            {% for minute in [0, 15, 30, 45] %}
                                {% set current_time = '%02d:%02d'|format(hour, minute) %}
                                {% set saved_block = time_blocks|selectattr('start_time', 'equalto', current_time)|first %}
                                <div class="time-block" data-time="{{ current_time }}">
                                    <div class="time-label">{{ current_time }}</div>
                                    <div class="time-content {% if saved_block and saved_block.task_id %}has-task{% endif %}"
                                         {% if saved_block and saved_block.task_id %}
                                         {% set task_category_color = none %}
                                         {% for category in categories %}
                                             {% for task in category.tasks %}
                                                 {% if task.id == saved_block.task_id %}
                                                     {% set task_category_color = category.color %}
                                                 {% endif %}
                                             {% endfor %}
                                         {% endfor %}
                                         style="background-color: {{ task_category_color }}20; border-left: 4px solid {{ task_category_color }};"
                                         {% endif %}>
                                        <select class="task-select">
                                            <option value="">Select a task</option>
                                            {% for category in categories %}
                                                <optgroup label="{{ category.name }}" data-category-id="{{ category.id }}" data-color="{{ category.color }}">
                                                    {% for task in category.tasks %}
                                                        <option value="{{ task.id }}"
                                                                data-category-color="{{ category.color }}"
                                                                data-category-name="{{ category.name }}"
                                                                {% if saved_block and saved_block.task_id == task.id %}selected{% endif %}>
                                                            {{ task.title }}
                                                        </option>
                                                    {% endfor %}
                                                </optgroup>
                                            {% endfor %}
                                        </select>
                                        <input type="text" class="task-notes"
                                               placeholder="Notes..."
                                               maxlength="15"
                                               value="{{ saved_block.notes if saved_block and saved_block.notes else '' }}">
                                        <div class="task-controls">
                                            <button type="button" class="btn btn-sm task-control-btn copy-down" title="Copy task to next block">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>

                    <!-- Afternoon Hours -->
                    <div class="time-block-column">
                        <h6 class="text-muted mb-2">Afternoon</h6>
                        {% for hour in range(current_user.day_split_time.hour, current_user.day_end_time.hour + 1) %}
                            {% for minute in [0, 15, 30, 45] %}
                                {% if hour < current_user.day_end_time.hour or (hour == current_user.day_end_time.hour and minute <= current_user.day_end_time.minute) %}
                                    {% set current_time = '%02d:%02d'|format(hour, minute) %}
                                    {% set saved_block = time_blocks|selectattr('start_time', 'equalto', current_time)|first %}
                                    <div class="time-block" data-time="{{ current_time }}">
                                        <div class="time-label">{{ current_time }}</div>
                                        <div class="time-content {% if saved_block and saved_block.task_id %}has-task{% endif %}"
                                             {% if saved_block and saved_block.task_id %}
                                             {% set task_category_color = none %}
                                             {% for category in categories %}
                                                 {% for task in category.tasks %}
                                                     {% if task.id == saved_block.task_id %}
                                                         {% set task_category_color = category.color %}
                                                     {% endif %}
                                                 {% endfor %}
                                             {% endfor %}
                                             style="background-color: {{ task_category_color }}20; border-left: 4px solid {{ task_category_color }};"
                                             {% endif %}>
                                            <select class="task-select">
                                                <option value="">Select a task</option>
                                                {% for category in categories %}
                                                    <optgroup label="{{ category.name }}" data-category-id="{{ category.id }}" data-color="{{ category.color }}">
                                                        {% for task in category.tasks %}
                                                            <option value="{{ task.id }}"
                                                                    data-category-color="{{ category.color }}"
                                                                    data-category-name="{{ category.name }}"
                                                                    {% if saved_block and saved_block.task_id == task.id %}selected{% endif %}>
                                                                {{ task.title }}
                                                            </option>
                                                        {% endfor %}
                                                    </optgroup>
                                                {% endfor %}
                                            </select>
                                            <input type="text" class="task-notes"
                                                   placeholder="Notes..."
                                                   maxlength="15"
                                                   value="{{ saved_block.notes if saved_block and saved_block.notes else '' }}">
                                            <div class="task-controls">
                                                <button type="button" class="btn btn-sm task-control-btn copy-down" title="Copy task to next block">
                                                    <i class="fas fa-arrow-down"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                    
                    <!-- Extra Time Blocks (for overtime/extra work) -->
                    {% if current_user.extra_blocks > 0 %}
                    <div class="time-block-column">
                        <h6 class="text-muted mb-2">Extra Time <small>(Overtime)</small></h6>
                        {% for i in range(current_user.extra_blocks) %}
                            {% set total_minutes = current_user.day_end_time.minute + (i * 15) + 15 %}
                            {% set hour = current_user.day_end_time.hour + (total_minutes // 60) %}
                            {% set minute = total_minutes % 60 %}
                            {% set current_time = '%02d:%02d'|format(hour, minute) %}
                            {% set saved_block = time_blocks|selectattr('start_time', 'equalto', current_time)|first %}
                            <div class="time-block extra-block" data-time="{{ current_time }}">
                                <div class="time-label">{{ loop.index }}</div>
                                <div class="time-content {% if saved_block and saved_block.task_id %}has-task{% endif %}"
                                     {% if saved_block and saved_block.task_id %}
                                     {% set task_category_color = none %}
                                     {% for category in categories %}
                                         {% for task in category.tasks %}
                                             {% if task.id == saved_block.task_id %}
                                                 {% set task_category_color = category.color %}
                                             {% endif %}
                                         {% endfor %}
                                     {% endfor %}
                                     style="background-color: {{ task_category_color }}20; border-left: 4px solid {{ task_category_color }};"
                                     {% endif %}>
                                    <select class="task-select">
                                        <option value="">Select a task</option>
                                        {% for category in categories %}
                                            <optgroup label="{{ category.name }}" data-category-id="{{ category.id }}" data-color="{{ category.color }}">
                                                {% for task in category.tasks %}
                                                    <option value="{{ task.id }}"
                                                            data-category-color="{{ category.color }}"
                                                            data-category-name="{{ category.name }}"
                                                            {% if saved_block and saved_block.task_id == task.id %}selected{% endif %}>
                                                        {{ task.title }}
                                                    </option>
                                                {% endfor %}
                                            </optgroup>
                                        {% endfor %}
                                    </select>
                                    <input type="text" class="task-notes"
                                           placeholder="Notes..."
                                           maxlength="15"
                                           value="{{ saved_block.notes if saved_block and saved_block.notes else '' }}">
                                    <div class="task-controls">
                                        <button type="button" class="btn btn-sm task-control-btn copy-down" title="Copy task to next block">
                                            <i class="fas fa-arrow-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>


        <div class="time-block-controls text-center mt-3">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm add-later-blocks">
                    <i class="fas fa-plus"></i> Add Later Blocks
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm remove-later-blocks">
                    <i class="fas fa-minus"></i> Remove Block
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Recovery Modal (Bootstrap) -->
<div class="modal fade" id="recoveryModal" tabindex="-1" aria-labelledby="recoveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recoveryModalLabel"><i class="fas fa-history me-2"></i>Data Recovery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="recoveryModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Work Hour Settings Modal -->
<div class="modal fade" id="workHourSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Work Hour Goals</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workHourSettingsForm">
                    <div class="mb-3">
                        <label for="weeklyGoal" class="form-label">Weekly Work Hour Goal</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="weeklyGoal" 
                                   min="1" max="168" step="0.5" 
                                   value="{{ current_user.weekly_work_goal if current_user.weekly_work_goal else 32 }}">
                            <span class="input-group-text">hours/week</span>
                        </div>
                        <div class="form-text">Set your target work hours per week (includes PTO)</div>
                    </div>
                    <div class="mb-3">
                        <label for="monthlyGoal" class="form-label">Monthly Work Hour Goal</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="monthlyGoal" 
                                   min="1" max="744" step="0.5" 
                                   value="{{ current_user.monthly_work_goal if current_user.monthly_work_goal else 140 }}">
                            <span class="input-group-text">hours/month</span>
                        </div>
                        <div class="form-text">Set your target work hours per month (includes PTO)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkHourSettings()">Save Goals</button>
            </div>
        </div>
    </div>
</div>

<style>
.time-indicator {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #ff3333;
    z-index: 100;
    pointer-events: none;
    border-top: 1px solid rgba(255, 51, 51, 0.8);
    box-shadow: 0 1px 3px rgba(255, 51, 51, 0.4);
}

.time-block {
    position: relative;
    height: 40px;  /* Set explicit height */
}

.time-block-column {
    position: relative;
}

#timeBlocks {
    position: relative;
}

.time-block-controls {
    padding: 10px;
    background: rgba(0,0,0,0.02);
    border-radius: 4px;
}

.time-block-controls button {
    min-width: 120px;
}

.time-block-controls .btn-group {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-block-controls .btn-outline-danger {
    border-left: none;
}
</style>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/timeblock.js') }}"></script>
<script>
window.userDayEndTime = '{{ current_user.day_end_time.strftime("%H:%M") if current_user.day_end_time else "16:30" }}';
window.userDaySplitTime = '{{ current_user.day_split_time.strftime("%H:%M") if current_user.day_split_time else "12:00" }}';
</script>
<script src="{{ url_for('static', filename='js/daily-plan.js') }}"></script>

{% endblock %}