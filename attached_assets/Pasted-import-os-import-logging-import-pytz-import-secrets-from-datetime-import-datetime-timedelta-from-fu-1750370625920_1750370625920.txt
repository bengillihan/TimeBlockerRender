import os
import logging
import pytz
import secrets
from datetime import datetime, timedelta
from functools import wraps
from flask import render_template, jsonify, request, redirect, url_for, flash, session
from flask_login import current_user, login_required, login_user, logout_user
from sqlalchemy import func
from app_factory import db
from cache_utils import cached, invalidate_cache, get_paginated_results

# Configure logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# Configure timezone
pacific_tz = pytz.timezone('America/Los_Angeles')

# Import models
from models import User, DailyPlan, Priority, TimeBlock, Category, Task, NavLink, DayTemplate, ToDo, Role, TaskComment

def create_default_categories(user):
    default_categories = ['APS', 'Church', 'Personal']
    for cat_name in default_categories:
        if not Category.query.filter_by(name=cat_name, user_id=user.id).first():
            category = Category(name=cat_name, user_id=user.id)
            db.session.add(category)
    db.session.commit()

def get_current_pacific_date():
    return datetime.now(pacific_tz).date()

def register_routes(app):
    """Register all routes with the Flask app"""
    
    # Set session to permanent but with defined lifetime
    @app.before_request
    def make_session_permanent():
        session.permanent = True
        # Marks the user's session as active to prevent premature disconnect
        if current_user.is_authenticated:
            session.modified = True

    # Ensure database connections are properly closed after each request
    @app.teardown_request
    def cleanup_request(exception=None):
        db.session.close()
        if exception:
            db.session.rollback()
            logger.error(f"Request exception: {str(exception)}")

    @app.route('/')
    def index():
        if not current_user.is_authenticated:
            return redirect(url_for('login'))

        # Convert date parameter to Pacific time if provided, otherwise use current Pacific time
        date_param = request.args.get('date')
        if date_param:
            date = datetime.strptime(date_param, '%Y-%m-%d').date()
        else:
            date = get_current_pacific_date()

        daily_plan = DailyPlan.query.filter_by(
            user_id=current_user.id,
            date=date
        ).first()

        # Get user's preferred start and end times, or use defaults
        day_start = current_user.day_start_time or datetime.strptime('09:00', '%H:%M').time()
        day_end = current_user.day_end_time or datetime.strptime('17:00', '%H:%M').time()

        # Get categories and their tasks for the time block selector
        categories = Category.query.filter_by(user_id=current_user.id).all()
        
        # Get all open tasks for the open tasks section, sorted by due date
        all_open_tasks = Task.query.filter(
            Task.user_id == current_user.id,
            Task.completed == False
        ).order_by(
            Task.due_date.asc().nullslast(),  # Due date ascending, nulls last
            Task.priority.desc()
        ).all()
        
        # Get all open todos sorted by due date
        all_todos = db.session.query(ToDo).filter(
            ToDo.user_id == current_user.id,
            ToDo.completed == False
        ).order_by(
            ToDo.due_date.asc().nullslast(),
            ToDo.priority.desc()
        ).all()
        
        # Get recurring todos specifically
        recurring_todos = db.session.query(ToDo).filter(
            ToDo.user_id == current_user.id,
            ToDo.is_recurring == True,
            ToDo.completed == False
        ).order_by(
            ToDo.next_occurrence.asc().nullslast(),
            ToDo.priority.desc()
        ).all()
        
        # Get all roles for filtering
        all_roles = db.session.query(Role).filter(Role.user_id == current_user.id).all()

        # Initialize empty lists/dicts for data
        time_blocks = []
        category_stats = {}
        total_minutes = 0
        priorities = []
        brain_dump = ''
        productivity_rating = 0

        if daily_plan:
            # Load priorities
            priorities = [{
                'content': p.content,
                'completed': p.completed
            } for p in daily_plan.priorities]

            # Load brain dump and rating
            brain_dump = daily_plan.brain_dump or ''
            productivity_rating = daily_plan.productivity_rating or 0

            # Process time blocks and calculate statistics
            for block in daily_plan.time_blocks:
                time_blocks.append({
                    'start_time': block.start_time.strftime('%H:%M'),
                    'task_id': block.task_id,
                    'completed': block.completed,
                    'notes': block.notes
                })

                if block.task_id:
                    task = Task.query.get(block.task_id)
                    if task:
                        # Calculate minutes (each block is 15 minutes)
                        minutes = 15
                        total_minutes += minutes

                        # Update category statistics
                        if task.category_id not in category_stats:
                            category_stats[task.category_id] = {
                                'name': task.category.name,
                                'color': task.category.color,
                                'minutes': 0,
                            }
                        category_stats[task.category_id]['minutes'] += minutes

        # Format date for display in Pacific time
        formatted_date = date.strftime('%Y-%m-%d')

        return render_template('index.html', 
                             daily_plan=daily_plan, 
                             date=formatted_date, 
                             categories=categories,
                             all_open_tasks=all_open_tasks,
                             all_todos=all_todos,
                             recurring_todos=recurring_todos,
                             all_roles=all_roles,
                             time_blocks=time_blocks,
                             category_stats=category_stats,
                             total_minutes=total_minutes,
                             priorities=priorities,
                             brain_dump=brain_dump,
                             productivity_rating=productivity_rating,
                             day_start=day_start,
                             day_end=day_end)

    @app.route('/login')
    def login():
        return render_template('login.html')

    @app.route('/tasks')
    @login_required
    def tasks():
        return render_template('tasks.html')

    @app.route('/task-dashboard')
    @login_required
    def task_dashboard():
        return render_template('task_dashboard.html')

    # API Routes
    @app.route('/api/categories', methods=['POST'])
    @login_required
    def add_category():
        data = request.get_json()
        name = data.get('name')
        color = data.get('color', '#6c757d')
        
        if not name:
            return jsonify({'error': 'Category name is required'}), 400
        
        # Check if category already exists for this user
        existing_category = Category.query.filter_by(name=name, user_id=current_user.id).first()
        if existing_category:
            return jsonify({'error': 'Category already exists'}), 400
        
        category = Category(name=name, color=color, user_id=current_user.id)
        db.session.add(category)
        db.session.commit()
        
        return jsonify({
            'id': category.id,
            'name': category.name,
            'color': category.color
        }), 201

    @app.route('/api/categories/<int:category_id>', methods=['PUT', 'DELETE'])
    @login_required
    def category_operations(category_id):
        category = Category.query.filter_by(id=category_id, user_id=current_user.id).first()
        if not category:
            return jsonify({'error': 'Category not found'}), 404
        
        if request.method == 'DELETE':
            db.session.delete(category)
            db.session.commit()
            return jsonify({'message': 'Category deleted'}), 200
        
        # PUT request
        data = request.get_json()
        name = data.get('name')
        color = data.get('color')
        
        if name:
            category.name = name
        if color:
            category.color = color
        
        db.session.commit()
        return jsonify({
            'id': category.id,
            'name': category.name,
            'color': category.color
        }), 200

    # Continue with all other routes...
    # (I'll add the rest of the routes in the next edit to keep this manageable)

    @app.route('/health')
    def health_check():
        return jsonify({'status': 'healthy', 'timestamp': datetime.utcnow().isoformat()}), 200

    # Add all other routes here...
    # For brevity, I'm including the health check and a few key routes
    # The complete implementation would include all routes from the original app.py