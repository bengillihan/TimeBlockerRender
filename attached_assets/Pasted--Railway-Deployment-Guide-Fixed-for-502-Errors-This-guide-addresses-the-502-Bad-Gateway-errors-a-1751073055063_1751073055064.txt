# Railway Deployment Guide - Fixed for 502 Errors

This guide addresses the 502 Bad Gateway errors and port issues you've been experiencing on Railway.

## What Was Fixed

### 1. Port Configuration Issues
- **Problem**: Multiple conflicting startup configurations
- **Solution**: Unified port handling using Railway's `$PORT` environment variable
- **Files Updated**: `Procfile`, `railway_start.py`, `railway.json`

### 2. Startup Complexity
- **Problem**: Overly complex startup script causing failures
- **Solution**: Simplified startup process with essential checks only
- **Files Updated**: `railway_start.py`, `start_simple.py`

### 3. Health Check Optimization
- **Problem**: Health check endpoint was slow and unreliable
- **Solution**: Fast, optimized health check for Railway's monitoring
- **Files Updated**: `app.py` (health endpoint)

## Railway Configuration

### Environment Variables Required
```
DATABASE_URL=postgresql://username:password@host:port/database
GOOGLE_OAUTH_CLIENT_ID=your_google_client_id
GOOGLE_OAUTH_CLIENT_SECRET=your_google_client_secret
SESSION_SECRET=your_session_secret
```

### Railway Settings
- **Health Check Path**: `/health`
- **Health Check Timeout**: 30 seconds
- **Restart Policy**: On Failure (max 3 retries)

## Deployment Steps

### 1. Update Your Railway Project
```bash
# Commit the changes
git add .
git commit -m "Fix Railway 502 errors - simplified deployment"
git push
```

### 2. Railway Dashboard Configuration
1. Go to your Railway project dashboard
2. Navigate to Settings → Environment Variables
3. Ensure these variables are set:
   - `DATABASE_URL` (your Supabase connection string)
   - `GOOGLE_OAUTH_CLIENT_ID`
   - `GOOGLE_OAUTH_CLIENT_SECRET`
   - `SESSION_SECRET`

### 3. Deploy Settings
- **Build Command**: Leave empty (Railway auto-detects Python)
- **Start Command**: `gunicorn --bind 0.0.0.0:$PORT --workers 1 --timeout 60 --keep-alive 5 --max-requests 1000 --max-requests-jitter 100 --preload --log-level info --access-logfile - --error-logfile - app:app`

### 4. Health Check Configuration
- **Path**: `/health`
- **Timeout**: 30 seconds
- **Interval**: 30 seconds

## Troubleshooting

### If You Still Get 502 Errors

1. **Check Railway Logs**
   ```bash
   # View deployment logs
   railway logs
   ```

2. **Verify Environment Variables**
   - Ensure `DATABASE_URL` is correctly formatted
   - Check that all required variables are set

3. **Test Health Endpoint**
   ```bash
   # Test locally first
   curl http://localhost:5000/health
   ```

4. **Alternative Startup**
   If the main startup fails, Railway will automatically try the simplified version.

### Common Issues and Solutions

#### Issue: "Port already in use"
**Solution**: The new configuration uses Railway's dynamic port assignment correctly.

#### Issue: "Database connection failed"
**Solution**: 
- Verify `DATABASE_URL` format
- Use Supabase connection pooling URL (port 6543)
- Check database credentials

#### Issue: "Application timeout"
**Solution**: 
- Reduced timeout to 60 seconds
- Single worker configuration for Railway free tier
- Optimized health check endpoint

## Monitoring Your Deployment

### Health Check Endpoint
Your app now has an optimized health check at `/health` that returns:
```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "2025-01-XX...",
  "environment": "railway"
}
```

### Railway Logs
Monitor your deployment with:
```bash
railway logs --follow
```

## Performance Optimizations

### For Railway Free Tier
- **Single Worker**: Prevents resource conflicts
- **Connection Pooling**: Optimized database connections
- **Request Limits**: Prevents memory issues
- **Timeout Settings**: Balanced for reliability

### Database Optimization
- **Connection Recycling**: Every 3 minutes
- **Pre-ping**: Validates connections before use
- **Pool Size**: Minimal for free tier constraints

## Success Indicators

Your deployment is successful when:
1. ✅ Railway shows "Deployed" status
2. ✅ Health check returns 200 status
3. ✅ Application responds to web requests
4. ✅ No 502 errors in logs

## Support

If you continue to experience issues:
1. Check Railway's status page
2. Review deployment logs
3. Verify environment variables
4. Test the health endpoint manually

The simplified configuration should resolve the 502 errors and port binding issues you were experiencing. 